{{ config(
    materialized = 'table',
    schema = 'GOLD'
) }}

with climate as (

    select
        dbn,
        school_name,
        tract_fips,
        year,
        climate_score,
        borough
    from {{ source('gold', 'climate_clean') }}

),

svi as (

    select
        tract_fips,
        rpl_theme1,
        rpl_theme2,
        rpl_theme3,
        rpl_theme4,
        rpl_themes        as svi_overall_score,
        svi_overall_bucket
    from {{ ref('silver_svi_enriched') }}

),

/*
    ----------------------------------------------------------------------------
    FUTURE CLIMATE INTEGRATION
    ----------------------------------------------------------------------------
    When a curated climate table becomes available in Snowflake (e.g. a table
    loaded from Databricks via your climate Bronze/Silver pipeline), you will:

      1. Replace <CLIMATE_TABLE_NAME> below with the real table.
      2. Uncomment the climate CTE.
      3. Replace the final SELECT with the join shown below.

    Example:

    climate as (
        select
            dbn,
            school_name,
            tract_fips,
            year,
            climate_score
        from {{ source('gold', 'climate_clean') }}
    ),

    joined as (
        select
            c.dbn,
            c.school_name,
            c.year,
            c.climate_score,
            s.svi_overall_score,
            s.svi_overall_bucket,
            s.rpl_theme1,
            s.rpl_theme2,
            s.rpl_theme3,
            s.rpl_theme4
        from climate c
        left join svi s using (tract_fips)
    )

    select * from joined;
    ----------------------------------------------------------------------------
*/

joined as (

    select
        c.dbn,
        c.school_name,
        c.borough,
        c.year,
        c.climate_score,
        s.svi_overall_score,
        s.svi_overall_bucket,
        s.rpl_theme1,
        s.rpl_theme2,
        s.rpl_theme3,
        s.rpl_theme4
    from climate c
    left join svi s using (tract_fips)

)

select * from joined
